---
title: "Drought vulnerability of tree growth"
author: ""
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


## HKK climate

```{r echo = FALSE, message=F, warning=F}

#load libraries
library(tidyverse)
library(lubridate)
library(httr)
library(janitor)

#reading the GitHub PAT (stored privately and locally)
#pat<-as.character(read.table("../data/HKK-dendro/git_pat.txt")[1,1])

# remotes:::download("DendroByBand.RData",
#                    "https://raw.githubusercontent.com/forestgeo/HKK-dendrobands/main/data/modified_data/DendroByBand.RData",
#                    auth_token = pat)

load("growth-precip-thailand/data/HKK-dendro/DendroByBand.RData")


dendrobyband<-merge(dendrobyband, trees, by="Tag")

hkk_OBSID$year<-year(hkk_OBSID$Date2)
hkk_OBSID$month<-month(hkk_OBSID$Date2)
hkk_OBSID$day<-day(hkk_OBSID$Date2)

#correcting two sets of wrong dates

hkk_OBSID$year[hkk_OBSID$year==2209]<-2009
hkk_OBSID$year[hkk_OBSID$month==1 & hkk_OBSID$Cno==5]<-2011

dendrobyband<-merge(dendrobyband, hkk_OBSID, by=c("OBSID", "Cno", "Date2", "Tag"))

dendrobyband$Date2<-as.Date(paste0(dendrobyband$year,"-", dendrobyband$month, "-", dendrobyband$day))

#getting climate data for all


#CHIRPS data ----

# CHIRPS data GEE code here - https://code.earthengine.google.com/894597bd093906fb0ff82320f29c0842


#chirps_hkk<-read.csv("../data/climate/CHIRPS_from_GEE.csv")
chirps_hkk<-read.csv("growth-precip-thailand/data/climate/CHIRPS_from_GEE.csv")
colnames(chirps_hkk)[1]<-"time"

#making dates manageable
chirps_hkk<- chirps_hkk %>%
  dplyr::mutate(time=as.Date(time, format = "%b %d, %Y"),
                year=year(time),
                month=month(time))

census_int<-dendrobyband%>%
  group_by(Cno) %>%
  dplyr::summarise(start=as.Date(min(Date2, na.rm = T)),
                   end=as.Date(max(Date2, na.rm=T)))#%>%
  #dplyr::mutate(type=ifelse(Cno %in% wet_census, "wet", "dry"))

spei_hkk<-read.csv("growth-precip-thailand/data/climate/SPEI_HKK_from_GEE.csv")
colnames(spei_hkk)[1]<-"time"

#making dates manageable
spei_hkk<- spei_hkk %>%
  dplyr::mutate(time=as.Date(time, format = "%b %d, %Y"),
                year=year(time),
                month=month(time))


pre_yr_census<-ggplot()+
  geom_line(data=chirps_hkk, aes(x=time, y=precipitation), col="blue", alpha=0.5)+
  geom_line(data=spei_hkk, aes(x=time, y=(100*SPEI_01_month-250)), col="red")+
  geom_rect(data=census_int, aes(xmin = start, xmax = end, ymin = -Inf, ymax = Inf), 
              fill = "grey10", alpha = 0.5) +
  geom_text(data=census_int, aes(x=start, y=500, 
                                 label= paste0("C", 1:29), angle=90), size=2)+
   scale_y_continuous(    # Features of the first axis
     name = "monthly rainfall (mm)",
     
     # Add a second axis and specify its features
     sec.axis = sec_axis(~(.+250)*0.01, name="SPEI"))+
  xlab("")+theme_bw()+ ylab("total monthly precipitation (mm) from CHIRPS")+
  ggtitle("HKK dendroband censuses and climate")+
  #scale_x_continuous(n.breaks=15)+
  theme(axis.text.x = element_text(angle=45))


#png("../doc/display/census_precip.png", width=6, height=3, res=300, units="in") 
#png("../doc/display/census_precip.png", width=6, height=3, res=300, units="in") 
pre_yr_census
#dev.off()



#rainfall per year

#-----------------Decisions on climate data-----------------------=
# Summarising climate data to relevant time window for SCBI
# As per issue #42 and KAT pub https://onlinelibrary-wiley-com.smithsonian.idm.oclc.org/doi/full/10.1111/gcb.15934
# HKK best climate variables are:
# PPT - previous Sep to current June (it is actually precipitation day freq, but using sum now)
# Tmax - current Apr to Oct
#---------------------------------------------------------------=

#applying these decisions and rescaling

#mean annual precip from 1981 to 2023 is 1698.4

#code - https://code.earthengine.google.com/b0eda787f2e1ba578bbf50a8a9d04843

climate_data_yr<-chirps_hkk %>%
  group_by(year) %>%
  summarise(
    tot_precip=sum(precipitation),
    pre_SeptoDec=sum(precipitation[month>=9]), #Sep to Dec precip for each year
    pre_JantoJun=sum(precipitation[month<=6]) #Jan to June precip for each year
    #tmx_window=sum(value[variable == "tmx"& month %in% 4:10])
)%>% #sum of potential evapotranspiration for current May to July
  mutate(
    pre_window=pre_JantoJun+lag(pre_SeptoDec), #adding prev year's June to Dec and current year's Jan to June
    tot_pre_diff=tot_precip-1698.4
    )

#standard deviation is 254.06

precip_plot<-ggplot(climate_data_yr)+
  geom_bar(aes(x=year, y=tot_pre_diff), stat="identity")+
  ylab("difference from 40-year mean (mm)")+
  geom_hline(yintercept = c(254.06, -254.06), lty=2)+
  theme_bw()
precip_plot




# library
library(ggridges)
library(ggplot2)
library(viridis)
library(hrbrthemes)

chirps_hkk$year_fac<-as.character(chirps_hkk$year)
chirps_hkk$year_fac<-factor(chirps_hkk$year)


# Plot
ggplot(chirps_hkk, aes(x = precipitation, y = year_fac, 
                       fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "rainfall", option = "C") +
  labs(title = 'Rainfall in HKK') +
  #theme_ipsum() +
  theme_bw()+
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )



```
```{r echo=F}

#remove all data with decimal errors, misplaced decimal

dendro.data<-dendrobyband %>%
  dplyr::rename(sp=SPCODE.UPDATE)%>%
  mutate(year=year(Date2)) %>%
  filter(is.na(DBH1_flag), DBH1_error=="none",
         win.decimal.error=="none", is.na(win.flag))%>%
  group_by(Cno, sp, Tag) %>%
  dplyr::summarise(calcDBH=calcDBH[which(n.dendro==min(n.dendro))],
                   Date2=Date2[which(n.dendro==min(n.dendro))],
                   Cii=max(Cii, na.rm=T))



#first fitting a line through the time series
obs.model.dbh<-nlme::lme(calcDBH~Cno, random=~1|Tag, data=dendro.data,
                         na.action=na.omit,
                         method="ML", control=(msMaxIter=100)) #had to increase the number of iterations

#standardised residuals calculated https://stat.ethz.ch/R-manual/R-devel/library/nlme/html/residuals.lme.html

std.res.dbh<-residuals(obs.model.dbh, type="pearson")
hist(std.res.dbh)
dendro.data$std.res<-rep(NA, nrow(dendro.data))
dendro.data$std.res[!is.na(dendro.data$calcDBH)]<-std.res.dbh
#defining all observation with abs(residual) >3 as an outlier
dendro.data$out<-factor(ifelse(abs(dendro.data$std.res)<=3, 0, 1))

#find the trees which have outlier observations
outs.Tag<-unique(dendro.data$Tag[dendro.data$out==1])

#plot trees that have outliers
ggplot(dendro.data[dendro.data$Tag %in%outs.Tag,],
       aes(x = Cno, y = calcDBH, col=factor(out), group = Tag))+
  geom_line(alpha=0.5)+geom_point()+
  scale_color_manual(values=c("grey20", "red", "grey"))

dendro.data.noouts<-dendro.data %>%
  filter(abs(std.res)<=3)%>%
  select(-c(std.res, out))
  #mutate(dbh3=ifelse(abs(std.res)<=3, calcDBH, NA)) #%>% #create an outlier removed column
  
```
```{r long-term growth rates}

# remotes:::download("../data/HKK-dendro/stem1.RData",
#                    "https://raw.githubusercontent.com/forestgeo/HKK-tree-growth-data/main/data/Census/raw_data/hkk.stem1.rdata",
#                    auth_token = pat)
# remotes:::download("../data/HKK-dendro/stem2.RData",
#                    "https://raw.githubusercontent.com/forestgeo/HKK-tree-growth-data/main/data/Census/raw_data/hkk.stem2.rdata",
#                    auth_token = pat)
# remotes:::download("../data/HKK-dendro/stem3.RData",
#                    "https://raw.githubusercontent.com/forestgeo/HKK-tree-growth-data/main/data/Census/raw_data/hkk.stem3.rdata",
#                    auth_token = pat)
# remotes:::download("../data/HKK-dendro/stem4.RData",
#                    "https://raw.githubusercontent.com/forestgeo/HKK-tree-growth-data/main/data/Census/raw_data/hkk.stem4.rdata",
#                    auth_token = pat)

load("growth-precip-thailand/data/HKK-dendro/stem1.RData")
load("growth-precip-thailand/data/HKK-dendro/stem2.RData")
load("growth-precip-thailand/data/HKK-dendro/stem3.RData")
load("growth-precip-thailand/data/HKK-dendro/stem4.RData")

hkk_census<-bind_rows(hkk.stem1, hkk.stem2, hkk.stem3, hkk.stem4)

hkk_census <- hkk_census %>%
  filter(status=="A")%>%
  filter(tag %in% dendro.data$Tag)%>%
  group_by(tag, StemTag)%>%
  dplyr::mutate(dbhmin1 = dplyr::lag(dbh, n=1, default=NA, order_by=StemTag),
                inc_annual = (dbh-dbhmin1)/5)%>%
  filter(!is.na(dbhmin1))%>%
  #average increment in cm
  dplyr::summarise(avg_inc = mean(inc_annual/10, na.rm=T),
                   sd_inc = sd(inc_annual/10, na.rm=T))
                  
#find the StemTags of trees that are in the dendro data
#match using the DBH04 column

#identify multistem trees from the census
multistem<-hkk_census %>%
  group_by(tag)%>%
  dplyr::summarise(n.stem=n())%>%
  rename(Tag=tag)

multistem<-merge(multistem, trees, by="Tag", all.x=T)

multistem<-multistem %>%
rename(tag=Tag)%>%
dplyr::mutate(dbh= (as.numeric(DBH.04)*10))

hkk.stem3.dendro<-hkk.stem3 %>%
  filter(tag %in% multistem$tag)

#add the StemTag values from hkk.stem3.dendro to multistem 
#match based on matching dbh and tag

multistem<- multistem %>%
dplyr::inner_join(select(hkk.stem3.dendro, c("tag", "StemTag", "dbh")), 
by=c("tag", "dbh"))


sum(multistem$tag != multistem$StemTag)
#there are no stemtags with values different from Tag
#all stems with dendrobands have them on the main stem?

#hkk_census<-hkk_census %>%
#  filter(StemTag %in% multistem$StemTag)


#since dendrobands are installed on trees with tag==StemTag
hkk_census<-hkk_census %>%
filter(tag==StemTag)

#there are 2271 trees in this dataset.

inc_census<-ggplot(data = hkk_census, aes(x=avg_inc)) +
  geom_density(alpha=0.5) +
  xlab("mean annual increment (cm)")+
  theme_bw()

png("growth-precip-thailand/doc/display/census_increment.png", width=4, height=4, units="in", res=300)
inc_census
dev.off()

#plot average increment for the top 4 species

hkk_census2<-hkk_census %>%
dplyr::rename(Tag=tag)

hkk_census2<-merge(hkk_census2, trees, by="Tag")
hkk_census2<-hkk_census2 %>%
dplyr::rename(sp=SPCODE.UPDATE)

png("growth-precip-thailand/doc/display/census_increment_species.png", width=4, height=4, units="in", res=300)
ggplot(hkk_census2 %>% filter(sp %in% c("SACCLI", "HOPEOD", "TETRNU", "POLYVI")), 
aes(x= factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI")), y = avg_inc, fill=factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI")))) +
  geom_violin(position = "dodge")+ 
    geom_boxplot(position="dodge", col="black", fill="white", width=0.1)+
  scale_fill_viridis_d()+
  labs(title = 'tree growth in HKK from census', 
  y="Annualised diameter increment (cm)", x="species") +
  theme_bw()+
  #geom_vline(xintercept=0, lty=2)+
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )
dev.off()
```

```{r calculating increments for all years}
  
hkk_census<-hkk_census %>%
rename(Tag=tag)  

#add long-term increment to dendro data
dendro.data.noouts<-merge(dendro.data.noouts, hkk_census, by="Tag", all.x=T)
dendro.data<-merge(dendro.data, hkk_census, by="Tag", all.x=T)

#making increments for each year

alt_census<-c(1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29)

dendro_inc<- dendro.data %>%
  filter(Cno %in% alt_census)%>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  mutate(calcDBH_min1=dplyr::lag(calcDBH, n=1, default=NA, order_by=Tag),
         cii_min1=dplyr::lag(Cii, n=1, default=NA, order_by=Tag),
         tdif=difftime(Date2, lag(Date2, n=1, default=NA, order_by=Tag), units = "days"),
         inc=calcDBH-calcDBH_min1,
         inc_annual=(inc/as.numeric(tdif))*365,
         inc.time=Cno-lag(Cno),
         #removing increment value if the previous measure was before the last year
         inc_annual=ifelse(inc.time==2, inc_annual, NA),
         treeID=paste0("HKK.", Tag))%>%
  filter(!is.na(inc))%>%
  filter(!is.na(inc_annual))%>%
  ungroup()%>%
  dplyr::mutate(
    diainc.scaled = scale(inc_annual),
    out.inc = ifelse(abs(diainc.scaled)>3, 1, 0))%>%
  filter(out.inc==0)
```
```{r species wise increments, echo=F}


#filter increments for two species

saccli<-dendro_inc %>%
  filter(sp == "SACCLI")

hopeod <- dendro_inc %>%
  filter(sp == "HOPEOD")

tetrnu<-dendro_inc %>%
  filter(sp == "TETRNU")

polyvi <- dendro_inc %>%
  filter(sp == "POLYVI")

#spaghetti plot saccli and hopeod increments over time

saccli_plot<-ggplot() +
  geom_line(data = saccli, aes(x=((Cno-3)/2)+2009, y=inc_annual, group=Tag)) +
  geom_line(data=saccli %>% group_by(Cno) %>% dplyr::summarise(mean_inc=mean(inc_annual, na.rm=T)), aes(x=((Cno-3)/2)+2009, y=mean_inc), col="red")+
  xlab("year") + ylab("diameter increment (cm)")+
  ggtitle("growth increments for SACCLI (deciduous)")+
  theme_bw()

hopeod_plot<-ggplot() +
  geom_line(data = hopeod, aes(x=((Cno-3)/2)+2009, y=inc_annual, group=Tag)) +
  geom_line(data=hopeod %>% group_by(Cno) %>% dplyr::summarise(mean_inc=mean(inc_annual, na.rm=T)), aes(x=((Cno-3)/2)+2009, y=mean_inc), col="red")+
  xlab("year") + ylab("diameter increment (cm)")+
  ggtitle("growth increments for HOPEOD (evergreen)")+
  theme_bw()

tetrnu_plot<-ggplot() +
  geom_line(data = tetrnu, aes(x=((Cno-3)/2)+2009, y=inc_annual, group=Tag)) +
  geom_line(data=tetrnu %>% group_by(Cno) %>% dplyr::summarise(mean_inc=mean(inc_annual, na.rm=T)), aes(x=((Cno-3)/2)+2009, y=mean_inc), col="red")+
  xlab("year") + ylab("diameter increment (cm)")+
  ggtitle("growth increments for TETRNU (deciduous)")+
  theme_bw()

polyvi_plot<-ggplot() +
  geom_line(data = polyvi, aes(x=((Cno-3)/2)+2009, y=inc_annual, group=Tag)) +
  geom_line(data=polyvi %>% group_by(Cno) %>% dplyr::summarise(mean_inc=mean(inc_annual, na.rm=T)), aes(x=((Cno-3)/2)+2009, y=mean_inc), col="red")+
  xlab("year") + ylab("diameter increment (cm)")+
  ggtitle("growth increments for POLYVI (evergreen)")+
  theme_bw()

png("growth-precip-thailand/doc/display/ind_increments.png", width=8, height=8, units="in", res=300)
grid.arrange(hopeod_plot, tetrnu_plot, polyvi_plot, saccli_plot, nrow=2)
dev.off()

top4<-dendro_inc %>%
filter(sp %in% c("SACCLI", "HOPEOD", "TETRNU", "POLYVI"))

#sample size per species per year
png("growth-precip-thailand/doc/display/top4_sample_size.png", width=8, height=4, units="in", res=300)
top4 %>% 
  group_by(sp, Cno) %>% 
  dplyr::summarise(n=n())%>%
  ggplot(aes(x=Cno, y=n, fill=factor(sp,levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI"))))+
  geom_bar(stat="identity")+
  scale_fill_viridis_d()+
  facet_grid(.~factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI")))+
  xlab("census number")+
  ylab("sample size")+
  guides(fill=guide_legend(title="species"))+
  theme_bw()
dev.off()

png("growth-precip-thailand/doc/display/top4_increments.png", width=8, height=4, units="in", res=300)
ggplot(top4, aes(x = inc_annual, y = factor(((Cno-3)/2)+2009), 
                       fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "growth", option = "H", direction=-1) +
  labs(title = 'tree growth in HKK (cm)', y="year") +
  #theme_ipsum() +
  facet_grid(.~factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI")))+
  theme_bw()+
  xlim(-1.5, 1.5)+
  geom_vline(xintercept=0, lty=2)+
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )
dev.off()


growth_top4<-ggplot(top4, aes(x=factor(((Cno-3)/2)+2009), y=inc_annual,
                                              fill=factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI")),
                                              color=factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI"))
                                              ))+ 
  geom_violin(position = "dodge")+ 
    geom_boxplot(position="dodge", col="black", fill="white", width=0.1)+
ylab("Annualised diameter increment (cm)")+theme_bw()+
facet_grid(.~factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI")))+
  geom_hline(yintercept = 0, lty=3)+
      theme(axis.text.x = element_text(angle=90))+
  ggtitle("HKK dendroband data from 2008 to 2023")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  guides(fill=guide_legend(title="species"),
         color=guide_legend(title="species"))+
         xlab("year")
         

png("growth-precip-thailand/doc/display/top4_increments_violin.png", width=8, height=4, units="in", res=300)
growth_top4
dev.off()

growth_top4

growth_top4_sum<-ggplot(top4, aes(x=factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI")), y=inc_annual,
                                              fill=factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI")),
                                              color=factor(sp, levels=c("HOPEOD", "TETRNU", "POLYVI", "SACCLI"))
                                              ))+ 
  geom_violin(position = "dodge")+ 
    geom_boxplot(position="dodge", col="black", fill="white", width=0.1)+
ylab("Annualised diameter increment (cm)")+
xlab("species")+theme_bw()+
  geom_hline(yintercept = 0, lty=3)+
  ggtitle("tree growth in HKK from dendrobands")+
  scale_fill_viridis_d()+
  scale_color_viridis_d()+
  guides(fill="none",
         color="none")
         

png("growth-precip-thailand/doc/display/top4_increments_sum.png", width=4, height=4, units="in", res=300)
growth_top4_sum
dev.off()

growth_top4
```


```{r plot increments}

dendro_2010<- dendro.data.noouts %>%
  filter(Cno %in% c(1, 3, 5))%>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  mutate(calcDBH_min1=dplyr::lag(calcDBH, n=1, default=NA, order_by=Tag),
         cii_min1=dplyr::lag(Cii, n=1, default=NA, order_by=Tag),
         tdif=difftime(Date2, lag(Date2, n=1, default=NA, order_by=Tag), units = "days"),
         inc=calcDBH-calcDBH_min1,
         inc_annual=(inc/as.numeric(tdif))*365,
         inc.time=Cno-lag(Cno),
         #removing increment value if the previous measure was before the last year
         inc_annual=ifelse(inc.time==2, inc_annual, NA),
         treeID=paste0("HKK.", Tag))%>%
  filter(!is.na(inc))%>%
  filter(!is.na(inc_annual))%>%
  ungroup()%>%
  dplyr::mutate(
    diainc.scaled = scale(inc_annual),
    out.inc = ifelse(abs(diainc.scaled)>3, 1, 0))%>%
  filter(out.inc==0)

quantiles_2009<-quantile(dendro_2010$inc_annual[dendro_2010$Cno==3], 
                         probs=c(0.25, 0.5, 0.75, 1))

quantiles_2010<-quantile(dendro_2010$inc_annual[dendro_2010$Cno==5], 
                         probs=c(0.25, 0.5, 0.75, 1))

dendro_2010_plot<-ggplot(data = dendro_2010, aes(x=inc_annual, group=factor(Cno), fill=factor(Cno), col=factor(Cno))) +
  geom_density(alpha=0.5) +
  scale_color_manual(values=c("forestgreen", "brown"))+
  scale_fill_manual(values=c("forestgreen", "brown"))+
  geom_vline(xintercept=quantiles_2009, col="forestgreen")+
  geom_text(aes(x=0.75, y=1, label="2009"), col="forestgreen", size=3)+
  geom_text(aes(x=0.75, y=1.5, label="2010"), col="brown", size=3)+
  geom_vline(xintercept=quantiles_2010, col="brown")+ 
  xlab("diameter increment (cm)") + ylab("density")+
  guides(col="none", fill="none")+
  theme_bw()


dendro_2015<- dendro.data.noouts %>%
  filter(Cno %in% c(11, 13, 15))%>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  mutate(calcDBH_min1=dplyr::lag(calcDBH, n=1, default=NA, order_by=Tag),
         cii_min1=dplyr::lag(Cii, n=1, default=NA, order_by=Tag),
         tdif=difftime(Date2, lag(Date2, n=1, default=NA, order_by=Tag), units = "days"),
         inc=calcDBH-calcDBH_min1,
         inc_annual=(inc/as.numeric(tdif))*365,
         inc.time=Cno-lag(Cno),
         #removing increment value if the previous measure was before the last year
         #inc=ifelse(inc.time==1, inc, NA),
         inc_annual=ifelse(inc.time==2, inc_annual, NA),
         treeID=paste0("HKK.", Tag))%>%
  filter(!is.na(inc))%>%
  filter(!is.na(inc_annual))%>%
  ungroup()%>%
  dplyr::mutate(
    diainc.scaled = scale(inc_annual),
    out.inc = ifelse(abs(diainc.scaled)>3, 1, 0))%>%
  filter(out.inc==0)

quantiles_2014<-quantile(dendro_2015$inc_annual[dendro_2015$Cno==13], 
                         probs=c(0.25, 0.5, 0.75, 1))

quantiles_2015<-quantile(dendro_2015$inc_annual[dendro_2015$Cno==15], 
                         probs=c(0.25, 0.5, 0.75, 1))

dendro_2015_plot<-ggplot(data = dendro_2015, aes(x=inc_annual, group=factor(Cno), fill=factor(Cno), col=factor(Cno))) +
  geom_density(alpha=0.5) +
  scale_color_manual(values=c("forestgreen", "brown"))+
  scale_fill_manual(values=c("forestgreen", "brown"))+
  geom_vline(xintercept=quantiles_2014, col="forestgreen")+
  geom_text(aes(x=0.75, y=1, label="2014"), col="forestgreen", size=3)+
  geom_text(aes(x=0.75, y=1.5, label="2015"), col="brown", size=3)+
  geom_vline(xintercept=quantiles_2015, col="brown")+ 
  xlab("diameter increment (cm)") + ylab("density")+
  guides(col="none", fill="none")+
  theme_bw()

dendro_2019<- dendro.data.noouts %>%
  filter(Cno %in% c(19, 21, 23))%>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  mutate(calcDBH_min1=dplyr::lag(calcDBH, n=1, default=NA, order_by=Tag),
         cii_min1=dplyr::lag(Cii, n=1, default=NA, order_by=Tag),
         tdif=difftime(Date2, lag(Date2, n=1, default=NA, order_by=Tag), units = "days"),
         inc=calcDBH-calcDBH_min1,
         inc_annual=(inc/as.numeric(tdif))*365,
         inc.time=Cno-lag(Cno),
         #removing increment value if the previous measure was before the last year
         #inc=ifelse(inc.time==1, inc, NA),
         inc_annual=ifelse(inc.time==2, inc_annual, NA),
         treeID=paste0("HKK.", Tag))%>%
  filter(!is.na(inc))%>%
  filter(!is.na(inc_annual))%>%
  ungroup()%>%
  dplyr::mutate(
    diainc.scaled = scale(inc_annual),
    out.inc = ifelse(abs(diainc.scaled)>3, 1, 0))%>%
  filter(out.inc==0)

quantiles_2018<-quantile(dendro_2019$inc_annual[dendro_2019$Cno==21], 
                         probs=c(0.25, 0.5, 0.75, 1))

quantiles_2019<-quantile(dendro_2019$inc_annual[dendro_2019$Cno==23], 
                         probs=c(0.25, 0.5, 0.75, 1))

dendro_2019_plot<-ggplot(data = dendro_2019, aes(x=inc_annual, group=factor(Cno), fill=factor(Cno), col=factor(Cno))) +
  geom_density(alpha=0.5) +
  scale_color_manual(values=c("forestgreen", "brown"))+
  scale_fill_manual(values=c("forestgreen", "brown"))+
  geom_vline(xintercept=quantiles_2018, col="forestgreen")+
  geom_text(aes(x=0.75, y=1, label="2018"), col="forestgreen", size=3)+
  geom_text(aes(x=0.75, y=1.5, label="2019"), col="brown", size=3)+
  geom_vline(xintercept=quantiles_2019, col="brown")+ 
  xlab("diameter increment (cm)") + ylab("density")+
  guides(col="none", fill="none")+
  theme_bw()


library(gridExtra)
png("growth-precip-thailand/doc/display/increments_raw.png", width=8, height=4, units="in", res=300)
#grid.arrange(dendro_2010_plot, dendro_2015_plot, dendro_2019_plot, nrow=1)
grid.arrange(dendro_2010_plot, dendro_2015_plot, nrow=1)
dev.off()

```

```{r top4 species drought resistance, echo=F}

resistance_2010_top4 <- top4 %>%
  filter(Cno %in% c(3, 5))%>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  dplyr::mutate(inc_min1=dplyr::lag(inc_annual, n=1, default=NA, order_by=Tag),
         resistance.div = inc_annual/avg_inc,
         resistance.dif = inc_annual-inc_min1,
         resistance.prop = (inc_annual-inc_min1)/avg_inc)%>%
  filter(!is.na(inc_min1), !is.infinite(resistance.div))

resistance_2015_top4 <- top4 %>%
  filter(Cno %in% c(11, 13, 15))%>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  mutate(inc_min1=dplyr::lag(inc_annual, n=1, default=NA, order_by=Tag),
         resistance.div = inc_annual/avg_inc,
         resistance.dif = inc_annual-inc_min1,
         resistance.prop = (inc_annual-inc_min1)/avg_inc)%>%
  filter(!is.na(inc_min1), !is.infinite(resistance.div))

#calculate quantiles for resistance.div for both years

quantiles_2010_top4<-quantile(resistance_2010_top4$resistance.div, 
                         probs=c(0.25, 0.5, 0.75, 1), na.rm=T)
quantiles_2015_top4<-quantile(resistance_2015_top4$resistance.div, 
                         probs=c(0.25, 0.5, 0.75, 1), na.rm=T)

#split the data into categories based on quantiles

resistance_2010_top4$quantile<-ifelse(resistance_2010_top4$resistance.div<quantiles_2010_top4[1], 1, ifelse(resistance_2010_top4$resistance.div<quantiles_2010_top4[2], 2, ifelse(resistance_2010_top4$resistance.div<quantiles_2010_top4[3], 3, 4)))
resistance_2015_top4$quantile<-ifelse(resistance_2015_top4$resistance.div<quantiles_2015_top4[1], 1, ifelse(resistance_2015_top4$resistance.div<quantiles_2015_top4[2], 2, ifelse(resistance_2015_top4$resistance.div<quantiles_2015_top4[3], 3, 4)))

#map of resistance.div quantiles for top 4 species
resistance_all<-rbind(resistance_2010_top4, resistance_2015_top4)
resistance_all$yr<-c(rep(2010, nrow(resistance_2010_top4)), rep(2015, nrow(resistance_2015_top4)))

resistance_all<-merge(resistance_all, select(trees, -"SPCODE.UPDATE"), by="Tag")

resistance_map<-ggplot(resistance_all, aes(x=X, y=Y, size=as.numeric(DBH.04), col=quantile))+
  geom_point(alpha=0.5)+
   scale_size(range = c(.1, 10), name="DBH (cm)")+
  guides(color=guide_legend(title="resistance"))+
  scale_colour_gradient(low="red", high="blue") +
  facet_grid(sp~yr)+
  theme_minimal()+
  coord_fixed()

png("growth-precip-thailand/doc/display/resistance_map_top4.png", width=8, height=8, units="in", res=300)
resistance_map
dev.off()


```

```{r drought resistance}

dec_williams<-read.csv("growth-precip-thailand/data/HKK-dendro/species.csv")

dec_williams<-dec_williams %>%
  filter(n.tree >= 5)

#2010 drought--------

resistance_2010 <- dendro_2010 %>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  mutate(inc_min1=dplyr::lag(inc_annual, n=1, default=NA, order_by=Tag),
         resistance.div = inc_annual/avg_inc,
         resistance.dif = inc_annual-inc_min1,
         resistance.prop = (inc_annual-inc_min1)/avg_inc)%>%
  filter(!is.na(inc_min1), !is.infinite(resistance.div))

resistance_2010<-merge(resistance_2010, select(dec_williams, -"X"), by="sp", all.x=T)
  
resistance_2010_div<-ggplot(data = resistance_2010, aes(x=resistance.div)) +
  geom_density(alpha=0.5) +
  geom_vline(xintercept = 0, lty=2)+
  theme_bw()

resistance_2010_dif<-ggplot(data = resistance_2010, aes(x=resistance.dif)) +
  geom_density(alpha=0.5) +
  theme_bw()

#2015 drought---------

resistance_2015 <- dendro_2015 %>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  mutate(inc_min1=dplyr::lag(inc_annual, n=1, default=NA, order_by=Tag),
         resistance.div = inc_annual/avg_inc,
         resistance.dif = inc_annual-inc_min1,
         resistance.prop = (inc_annual-inc_min1)/avg_inc)%>%
  filter(!is.na(inc_min1), !is.infinite(resistance.div))

resistance_2015<-merge(resistance_2015, select(dec_williams, -"X"), by="sp", all.x=T)
  
resistance_2015_div<-ggplot(data = resistance_2015, aes(x=resistance.div)) +
  geom_density(alpha=0.5) +
  geom_vline(xintercept = 0, lty=2)+
  theme_bw()

resistance_2015_dif<-ggplot(data = resistance_2015, aes(x=resistance.dif)) +
  geom_density(alpha=0.5) +
  theme_bw()

#2019 drought--------------

resistance_2019 <- dendro_2019 %>%
  group_by(Tag) %>% #grouping by treeID to calculate increment
  mutate(inc_min1=dplyr::lag(inc_annual, n=1, default=NA, order_by=Tag),
         resistance.div = inc_annual/inc_min1,
         resistance.dif = inc_annual-inc_min1,
         resistance.prop = (inc_annual-inc_min1)/inc_min1)%>%
  filter(!is.na(inc_min1), !is.infinite(resistance.div))

resistance_2019<-merge(resistance_2019, select(dec_williams, -"X"), by="sp", all.x=T)
  
resistance_2019_div<-ggplot(data = resistance_2019, aes(x=resistance.div)) +
  geom_density(alpha=0.5) +
  theme_bw()

resistance_2019_dif<-ggplot(data = resistance_2019, aes(x=resistance.dif)) +
  geom_density(alpha=0.5) +
  theme_bw()

png("../doc/display/resistance_dif.png", width=4, height=8, units="in", res=300)
grid.arrange(resistance_2010_dif, resistance_2015_dif, resistance_2019_dif, nrow=3)
dev.off()

library(gridExtra)

#png("growth-precip-thailand/doc/display/resistance_div.png", width=4, height=8, units="in", res=300)
#grid.arrange(resistance_2010_div, resistance_2015_div, resistance_2019_div, nrow=3)
#dev.off()

png("growth-precip-thailand/doc/display/resistance_div.png", width=8, height=4, units="in", res=300)
grid.arrange(resistance_2010_div, resistance_2015_div, nrow=1)
dev.off()

```

```{r resistance map}

quantiles_2010_dif<-quantile(resistance_2010$resistance.dif, 
                         probs=c(0.25, 0.5, 0.75, 1))

quantiles_2015_dif<-quantile(resistance_2015$resistance.dif, 
                         probs=c(0.25, 0.5, 0.75, 1))

quantiles_2019_dif<-quantile(resistance_2019$resistance.dif, 
                         probs=c(0.25, 0.5, 0.75, 1))

resistance_2010$quantile<-ifelse(resistance_2010$resistance.dif<quantiles_2010_dif[1], 1, ifelse(resistance_2010$resistance.dif<quantiles_2010_dif[2], 2,
            ifelse(resistance_2010$resistance.dif<quantiles_2010_dif[3], 3, 4))
                   
                                 )

resistance_2015$quantile<-ifelse(resistance_2015$resistance.dif<quantiles_2015_dif[1], 1, ifelse(resistance_2015$resistance.dif<quantiles_2015_dif[2], 2,
            ifelse(resistance_2015$resistance.dif<quantiles_2015_dif[3], 3, 4))
                   
                                 )

resistance_2019$quantile<-ifelse(resistance_2019$resistance.dif<quantiles_2019_dif[1], 1, ifelse(resistance_2019$resistance.dif<quantiles_2019_dif[2], 2,
            ifelse(resistance_2019$resistance.dif<quantiles_2019_dif[3], 3, 4))
                   
                                 )

quantiles_2010_div<-quantile(resistance_2010$resistance.div, 
                         probs=c(0.25, 0.5, 0.75, 1), na.rm=T)

quantiles_2015_div<-quantile(resistance_2015$resistance.div, 
                         probs=c(0.25, 0.5, 0.75, 1), na.rm=T)

quantiles_2019_div<-quantile(resistance_2019$resistance.div, 
                         probs=c(0.25, 0.5, 0.75, 1), na.rm=T)

resistance_2010$quantile.div<-ifelse(resistance_2010$resistance.div<quantiles_2010_div[1], 1, ifelse(resistance_2010$resistance.div<quantiles_2010_div[2], 2,
            ifelse(resistance_2010$resistance.div<quantiles_2010_div[3], 3, 4))
                   
                                 )

resistance_2015$quantile.div<-ifelse(resistance_2015$resistance.div<quantiles_2015_div[1], 1, ifelse(resistance_2015$resistance.div<quantiles_2015_div[2], 2,
            ifelse(resistance_2015$resistance.div<quantiles_2015_div[3], 3, 4))
                   
                                 )

resistance_2019$quantile.div<-ifelse(resistance_2019$resistance.div<quantiles_2019_div[1], 1, ifelse(resistance_2019$resistance.div<quantiles_2019_div[2], 2,
            ifelse(resistance_2019$resistance.div<quantiles_2019_div[3], 3, 4))
                   
                                 )


resistance_all<-rbind(resistance_2010, resistance_2015)
resistance_all$yr<-c(rep(2010, nrow(resistance_2010)), rep(2015, nrow(resistance_2015)))

resistance_all<-merge(resistance_all, select(trees, -"SPCODE.UPDATE"), by="Tag")

resistance_map<-ggplot(resistance_all, aes(x=X, y=Y, size=as.numeric(DBH.04), col=quantile.div))+
  geom_point(alpha=0.5)+
   scale_size(range = c(.1, 10), name="DBH (cm)")+
  guides(color=guide_legend(title="resistance"))+
  scale_colour_gradient(low="red", high="blue") +
  facet_grid(yr~.)+
  theme_minimal()+
  coord_fixed()

png("growth-precip-thailand/doc/display/resistance_map.png", width=8, height=6, units="in", res=300)
resistance_map
dev.off()
```
```{r basic model}

resistance_all$ciiF<-ordered(resistance_all$cii_min1)

model_2010<-glm(resistance.div ~ calcDBH_min1 + ciiF + williams_dec+
                  calcDBH_min1*ciiF + 
                  calcDBH_min1*williams_dec+
                  ciiF*williams_dec,
                data=resistance_all[resistance_all$yr==2010,])

summary(model_2010)

model_2015<-glm(resistance.div ~ calcDBH_min1 + ciiF + williams_dec+
                  calcDBH_min1*ciiF + 
                  calcDBH_min1*williams_dec+
                  ciiF*williams_dec,
                data=resistance_all[resistance_all$yr==2015,])

summary(model_2015)


summary(model_2019)



resistance_model<-resistance_all %>%
  select(resistance.div, calcDBH_min1, ciiF, williams_dec, yr, quantile)

resistance_model<-resistance_model[complete.cases(resistance_model),]


library(lme4)
library(nlme)
model_all<-lm(resistance.div ~ calcDBH_min1 + ciiF + williams_dec+
                  calcDBH_min1*ciiF + 
                  calcDBH_min1*williams_dec+
                  ciiF*williams_dec + yr,
                data=resistance_model,
                )

model_all
anova(model_all)


model_all_cat<-lme(quantile ~ calcDBH_min1 + cii_min1 + williams_dec+
                  calcDBH_min1*cii_min1 + 
                  calcDBH_min1*williams_dec+
                  cii_min1*williams_dec,
                random=~1|yr,
                data=resistance_model)

model_all_cat
anova(model_all_cat)
```

```{r predictions, echo=F}

library(sjPlot)

plot_model(model_all, type="pred", terms=c("ciiF","williams_dec"), show.data = T)
plot_model(model_all, type="pred", terms=c("cii_min1"), show.data = T)
plot_model(model_all, type="pred", terms=c("williams_dec"), show.data = T)
plot_model(model_all, type="pred", terms=c("calcDBH_min1"), show.data = T)


plot_model(model_all, type = "est")+
  theme_bw()+ylim(c(-0.25, 0.25))+
  geom_hline(yintercept = 0)

plot_model(model_all_cat, type = "est")+
  theme_bw()+ylim(c(-0.25, 0.25))+
  geom_hline(yintercept = 0)

plot_model(model_all_cat, type="pred", terms=c("calcDBH_min1","williams_dec"), show.data = T)
  


# Create a new data frame for predictions
new_data <- expand.grid(
  calcDBH_min1 = seq(min(resistance_model$calcDBH_min1), max(resistance_model$calcDBH_min1), length.out = 100),
  cii_min1 = seq(min(resistance_model$cii_min1), max(resistance_model$cii_min1), length.out = 100),
  williams_dec = seq(min(resistance_model$williams_dec), max(resistance_model$williams_dec), length.out = 100)
)

# Generate predictions
new_data$predicted <- predict(model_all, newdata = new_data, level = 0)

# Create the plot
ggplot(resistance_model, aes(x = williams_dec, y = resistance.dif)) +
  geom_point() +
  geom_line(data = new_data[new_data$cii_min1==2,], aes(y = predicted)) +
  theme_minimal() +
  labs(x = "Deciduousness", y = "Drought resistance", title = "Predictions from LME Model")


```




##Distribution of data with size, exposure and deciduousness

```{r data distribution, echo=F}

#growth data all years ridge plot
png("growth-precip-thailand/doc/display/growth_allyrs2.png", width=4, height=4, units="in", res=300)
ggplot(dendro_inc, aes(x = inc_annual, y = factor(((Cno-3)/2)+2009), 
                       fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "growth", option = "H", direction=-1) +
  labs(title = 'tree growth in HKK (cm)', y="year") +
  #theme_ipsum() +
  theme_bw()+
  xlim(-1.5, 1.5)+
  geom_vline(xintercept=0, lty=2)+
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )
dev.off()

#2014 data distribution with size, exposure and deciduousness

png("../doc/display/dbh_cii.png", width=4, height=4, units="in", res=300)
ggplot(growth_2014, aes(x = dbh, y = factor(cii), 
                       fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "growth", option = "C", direction=-1) +
  labs(title = 'DBH in 2014 (cm)', y="canopy illumination") +
  #theme_ipsum() +
  theme_bw()+
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )
dev.off()

length(unique(growth_2014$sp))

png("../doc/display/growth_cii.png", width=4, height=4, units="in", res=300)
ggplot(growth_2014, aes(x = diainc, y = factor(cii), 
                       fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "growth", option = "C", direction=-1) +
  labs(title = 'growth in 2014 (cm)', y="canopy illumination") +
  #theme_ipsum() +
  theme_bw()+
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )
dev.off()

dec_williams<-read.csv("../data/HKK-dendro/species.csv")

dec_williams<-dec_williams %>%
  filter(n.tree >= 5)

trial<-merge(growth_2014, dec_williams, by="sp")

png("../doc/display/dbh_cii.png", width=4, height=4, units="in", res=300)
ggplot(trial, aes(x = williams_dec, y = factor(Cii), 
                       fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "growth", option = "C", direction=-1) +
  labs(title = 'deciduousness', y="canopy illumination") +
  #theme_ipsum() +
  theme_bw()+
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )
dev.off()


```



